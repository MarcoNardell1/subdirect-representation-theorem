open import Overture using ( 𝓞 ; 𝓥 ; Signature ; ∣_∣)

module Prod.Subembedding {𝑆 : Signature 𝓞 𝓥} where
open import Agda.Builtin.Equality using (_≡_)
open import Level
open import Data.Product
open import Relation.Binary using (Setoid) renaming (Rel to BinRel)
open import Function using (_∘_ ; Func)
open import Function.Construct.Composition using (function)

open import Base.Relations using (0[_])
open import Setoid.Algebras  {𝑆 = 𝑆}
open import Setoid.Subalgebras.Subalgebras {𝑆 = 𝑆} 
open import Setoid.Functions using (IsSurjective ; IsBijective ; BijInv)
open import Setoid.Homomorphisms {𝑆 = 𝑆} hiding (_≅_ ; mkiso)
open import Setoid.Homomorphisms.Isomorphisms {𝑆 = 𝑆}

open import Prod.Subdirect
open import Prod.ImageProperties 

private variable α β ρᵅ ρᵝ i : Level

-- Subdirect embeddings
{-
  An embedding g : 𝐁 → ⨅ 𝐀ᵢ is called subdirect if DirImage(g(𝐁)) is a subdirect product of ⟨ 𝐀ᵢ : i ∈ I ⟩.
  g is also called the subdirect representation of 𝐁
-}

module _ {I : Set i} (𝐁 : Algebra β ρᵝ) (𝓐 : I → Algebra α ρᵅ) where 
   open Algebra 𝐁 renaming (Domain to B)
   open Algebra (⨅ 𝓐) renaming (Domain to A)

   genAlgFromMon : (h : mon 𝐁 (⨅ 𝓐)) → Algebra (β ⊔ (α ⊔ i) ⊔ (ρᵅ ⊔ i)) (ρᵅ ⊔ i)
   genAlgFromMon h = HomImageOf[ mon→hom 𝐁 (⨅ 𝓐) h ]
       
   record IsSubEmb (h : Func B A) : Set (ov (i ⊔ α ⊔ ρᵅ ⊔ β ⊔ ρᵝ))  where
     field
       Mon : IsMon 𝐁 (⨅ 𝓐) h
       genAlg≤Prod : (genAlgFromMon (h , Mon)) ≤ (⨅ 𝓐) 
       IsSubdirProd : IsSubdirectProduct (genAlgFromMon (h , Mon)) 𝓐 genAlg≤Prod
     
   SubdirectEmbedding : Set ((ov (i ⊔ α ⊔ ρᵅ ⊔ β ⊔ ρᵝ)))
   SubdirectEmbedding = Σ (Func B A) IsSubEmb

