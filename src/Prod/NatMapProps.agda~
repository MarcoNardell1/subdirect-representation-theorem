open import Overture using ( ğ“ ; ğ“¥ ; Signature ; âˆ£_âˆ£)

module Prod.NatMapProps {ğ‘† : Signature ğ“ ğ“¥} where
open import Agda.Builtin.Equality using (_â‰¡_)
open import Level
open import Data.Product
open import Relation.Binary using (Setoid) renaming (Rel to BinRel)
open import Function using (_âˆ˜_ ; Func)
open import Function.Construct.Composition using (function)

open import Base.Relations using (0[_])
open import Setoid.Algebras  {ğ‘† = ğ‘†}
open import Setoid.Subalgebras.Subalgebras {ğ‘† = ğ‘†} 
open import Setoid.Functions using (IsSurjective ; IsBijective ; BijInv)
open import Setoid.Homomorphisms {ğ‘† = ğ‘†} hiding (_â‰…_ ; mkiso)
open import Setoid.Homomorphisms.Isomorphisms {ğ‘† = ğ‘†}

open import Prod.Subdirect
open import Prod.ImageProperties 
open import Prod.Subembedding

private variable Î± Î² Ïáµ… Ïáµ i : Level

{-
Proposition: Let ğ€ an algebra and let Î¸áµ¢ a congruence on ğ€ for every i âˆˆ I.
If â‹‚_{i âˆˆ I} Î¸áµ¢ = 0_A then the natrual map ğ€ â†’ â¨…_{iâˆˆ I} ğ€/Î¸áµ¢ is a subdirect embedding.
Conversely,  if g â†’ ğ€ â¨… ğáµ¢ is a subdirect embedding then Î¸áµ¢ = ker(páµ¢ âˆ˜ g), we have âˆ©Î¸áµ¢ = 0_A and ğ€/Î¸áµ¢ â‹ ğáµ¢.
-}

prodQuot : âˆ€ {â„“} {I : Set i} (ğ€ : Algebra Î± Ïáµ…) (Î¸ : I â†’ Con ğ€ {â„“ = â„“}) â†’ Algebra (Î± âŠ” i) (i âŠ” â„“)
prodQuot {Î± = Î±} {â„“ = â„“} {I = I} ğ€ Î¸ = â¨… family
  where
    family : I â†’ Algebra Î± â„“ 
    family  i = ğ€ â•± (Î¸ i)

module _ {â„“} {I : Set i} (ğ€ : Algebra Î± Ïáµ…) (Î¸ : I â†’ Con ğ€ {â„“}) where
  open Algebra ğ€ renaming (Domain to A)
  open Setoid A renaming (Carrier to Car)

  famOfCons : I â†’ Algebra Î± â„“
  famOfCons i = ğ€ â•± (Î¸ i)
  
  prodOfQuot : Algebra (Î± âŠ” i) (i âŠ” â„“)
  prodOfQuot = prodQuot {I = I} ğ€ Î¸

  open Algebra prodOfQuot renaming (Domain to â¨…A/Î¸)
  open Setoid â¨…A/Î¸ renaming (Carrier to pCar)

  NatMap : Func A â¨…A/Î¸
  NatMap = record { f = Î» x j â†’ x ; cong = Î» x=y j â†’ IsCongruence.reflexive (projâ‚‚ (Î¸ j)) x=y }

  familyOfRels : (I â†’ Con ğ€ {â„“}) â†’ I â†’ BinRel Car â„“
  familyOfRels Î¸ = Î» i â†’ projâ‚ (Î¸ i) 

  -- First statement of proposition

  â‹‚áµ£ : âˆ€ {i Ï s} (I : Set i) â†’ (I â†’ BinRel Car Ï) â†’ BinRel Car (Ï âŠ” i âŠ” s)
  â‹‚áµ£ {j} {Ï} {s} I R = Î» x y â†’ (i : I) â†’ Lift (Ï âŠ” j âŠ” s) (R i x y)

  -- El goal 1 sale con la formalizacion de la proposicion 3.14
  -- El goal 2 sale inmediatamente del goal 1
  -- El goal 3 sale por el final de la prueba de la prop en papel
  NatMapIsSubEmb : (â‹‚áµ£ {s = Î± âŠ” Ïáµ… âŠ” â„“} I (familyOfRels Î¸)) â‰¡ 0[ Car ] {Ï = â„“ âŠ” Ïáµ… âŠ” i}
                 â†’ IsSubEmb ğ€ famOfCons  NatMap
  NatMapIsSubEmb p = record { Mon = {!!} ; genAlgâ‰¤Prod = {!!} ; IsSubdirProd = {!!} }
